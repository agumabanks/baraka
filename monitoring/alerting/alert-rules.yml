groups:
  - name: baraka-logistics-alerts
    interval: 30s
    rules:
      # API & Service Availability
      - alert: HighErrorRate
        expr: |
          (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) > 0.01
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "High error rate detected (>1%)"
          description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"
          runbook: "https://wiki.sanaa.co/runbooks/high-error-rate"

      - alert: ServiceDown
        expr: |
          up{job=~"laravel-app|api-server"} == 0
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.instance }} has been unreachable for 2 minutes"
          runbook: "https://wiki.sanaa.co/runbooks/service-down"

      # Latency & Performance
      - alert: HighLatency
        expr: |
          histogram_quantile(0.99, http_request_duration_seconds) > 1
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High API latency detected (p99 > 1s)"
          description: "P99 latency is {{ $value }}s for {{ $labels.endpoint }}"
          runbook: "https://wiki.sanaa.co/runbooks/high-latency"

      # Database & Queue
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          (mysql_global_status_threads_connected / mysql_global_variables_max_connections) > 0.8
        for: 5m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "Database connection pool 80% utilized"
          description: "Current connections: {{ $value | humanizePercentage }} of max"

      - alert: QueueBacklogCritical
        expr: |
          queue_length > 10000
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Queue backlog critical (>10k jobs)"
          description: "{{ $labels.queue }} has {{ $value }} pending jobs"
          runbook: "https://wiki.sanaa.co/runbooks/queue-backlog"

      - alert: WebhookDeliveryFailureRate
        expr: |
          (sum(rate(webhook_delivery_failed_total[5m])) / sum(rate(webhook_delivery_attempts_total[5m]))) > 0.05
        for: 15m
        labels:
          severity: warning
          team: integrations
        annotations:
          summary: "Webhook delivery failure rate > 5%"
          description: "Failed delivery rate: {{ $value | humanizePercentage }}"
          runbook: "https://wiki.sanaa.co/runbooks/webhook-failures"

      # Capacity & Resources
      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "Disk space low on {{ $labels.instance }} (<10%)"
          description: "Available: {{ $value | humanize }}B"

      - alert: MemoryUsageHigh
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "Memory usage critical on {{ $labels.instance }} (>90%)"
          description: "Current usage: {{ $value | humanizePercentage }}"

      - alert: BranchCapacityExceeded
        expr: |
          (branch_current_load / branch_capacity) > 0.95
        for: 10m
        labels:
          severity: critical
          team: operations
        annotations:
          summary: "Branch {{ $labels.branch_code }} capacity exceeded (95%+)"
          description: "Current load: {{ $value | humanizePercentage }} of capacity"
          runbook: "https://wiki.sanaa.co/runbooks/branch-capacity"

      - alert: HubProcessingDelayHigh
        expr: |
          avg(shipment_processing_time_seconds) > 300
        for: 15m
        labels:
          severity: warning
          team: operations
        annotations:
          summary: "Hub processing delay > 5 minutes"
          description: "Average processing time: {{ $value }}s"

      # Data Integrity & Monitoring
      - alert: MissingBackup
        expr: |
          time() - backup_last_successful_timestamp > 86400
        labels:
          severity: critical
          team: database
        annotations:
          summary: "No backup in last 24 hours"
          description: "Last backup: {{ $value | humanizeDuration }} ago"
          runbook: "https://wiki.sanaa.co/runbooks/backup-failures"

      - alert: ReplicationLag
        expr: |
          mysql_slave_status_seconds_behind_master > 30
        for: 5m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "Database replication lag > 30 seconds"
          description: "Current lag: {{ $value }}s"

      - alert: ShipmentScanAccuracyLow
        expr: |
          scan_accuracy_percentage < 0.95
        for: 30m
        labels:
          severity: warning
          team: operations
        annotations:
          summary: "Scan accuracy below 95% threshold"
          description: "Current accuracy: {{ $value | humanizePercentage }}"

      - alert: ApiRateLimitExceeded
        expr: |
          sum(rate(http_requests_total{status="429"}[5m])) > 100
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High rate of 429 (Too Many Requests) responses"
          description: "Rate-limited requests: {{ $value }}/sec"

      # Alerting System
      - alert: PrometheusEvaluationFailures
        expr: |
          increase(prometheus_rule_evaluation_failures_total[5m]) > 0
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Prometheus evaluation failures detected"
          description: "{{ $value }} evaluation failures in last 5 minutes"

      # Webhook & EDI Specific Alerts
      - alert: WebhookLatencySpike
        expr: |
          histogram_quantile(0.95, sum(rate(webhook_delivery_latency_bucket[5m])) by (le)) > 0.05
        for: 10m
        labels:
          severity: warning
          team: integrations
        annotations:
          summary: "Webhook delivery latency p95 above 50ms"
          description: "p95 latency is {{ $value | humanizeDuration }} for webhook deliveries"
          runbook: "https://wiki.sanaa.co/runbooks/webhook-latency"

      - alert: WebhookQueueStalled
        expr: |
          increase(webhook_delivery_retry_queue_stalled_total[5m]) > 0
        labels:
          severity: critical
          team: integrations
        annotations:
          summary: "Webhook retry queue stalled"
          description: "Stalled deliveries detected for {{ $labels.endpoint_id }}"
          runbook: "https://wiki.sanaa.co/runbooks/webhook-retry"

      - alert: EdiTransactionFailureRate
        expr: |
          (sum(rate(edi_transaction_failures_total[10m])) / sum(rate(edi_transaction_total[10m]))) > 0.02
        for: 10m
        labels:
          severity: warning
          team: integrations
        annotations:
          summary: "EDI failures exceeded 2% threshold"
          description: "Failure rate {{ $value | humanizePercentage }} over last 10m"
          runbook: "https://wiki.sanaa.co/runbooks/edi-failures"

      - alert: EdiAckDelayed
        expr: |
          max(edi_ack_latency_seconds) > 120
        for: 5m
        labels:
          severity: warning
          team: integrations
        annotations:
          summary: "EDI acknowledgements delayed >2 minutes"
          description: "Ack latency is {{ $value | humanizeDuration }}"
          runbook: "https://wiki.sanaa.co/runbooks/edi-ack"

      # Mobile scanning + device alerts
      - alert: MobileScanErrorSpike
        expr: |
          increase(mobile_scan_errors_total[5m]) > 50
        labels:
          severity: warning
          team: operations
        annotations:
          summary: "Mobile scan error spike detected"
          description: "{{ $value }} errors recorded within 5 minutes"
          runbook: "https://wiki.sanaa.co/runbooks/mobile-scanning"

      - alert: DeviceAuthenticationFailure
        expr: |
          increase(device_auth_failures_total[10m]) > 25
        labels:
          severity: warning
          team: operations
        annotations:
          summary: "Device authentication failures at field level"
          description: "{{ $value }} failures in last 10 minutes"

      - alert: OfflineQueueBacklog
        expr: |
          max(mobile_offline_queue_depth) > 500
        for: 10m
        labels:
          severity: warning
          team: operations
        annotations:
          summary: "Offline mobile scan queue backlog (>500)"
          description: "Current backlog: {{ $value }}"

      # Analytics & Cache tuning
      - alert: AnalyticsQueryP99High
        expr: |
          histogram_quantile(0.99, sum(rate(analytics_query_duration_seconds_bucket[5m])) by (le)) > 2
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Analytics query p99 above 2 seconds"
          description: "p99 is {{ $value }} seconds"
          runbook: "https://wiki.sanaa.co/runbooks/analytics-latency"

      - alert: CacheHitRateDropping
        expr: |
          (1 - cache_miss_ratio{cache="redis_branch_analytics"}) > 0.3
        for: 15m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Branch analytics cache hit rate below 70%"
          description: "Hit rate: {{ (1 - $value) | humanizePercentage }}"
          runbook: "https://wiki.sanaa.co/runbooks/cache-hit-rate"

      - alert: RedisConnectionPoolHigh
        expr: |
          redis_connected_clients > redis_config_maxclients * 0.85
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "Redis connection usage above 85%"
          description: "Connections: {{ $value }}"

      # Security & compliance
      - alert: SanctumAuthFailures
        expr: |
          increase(sanctum_auth_failures_total[5m]) > 100
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Spike in Sanctum auth failures"
          description: "{{ $value }} failures detected"
          runbook: "https://wiki.sanaa.co/runbooks/auth-failures"

      - alert: FirewallBlocksSpike
        expr: |
          increase(app_waf_blocked_requests_total[5m]) > 250
        labels:
          severity: warning
          team: security
        annotations:
          summary: "WAF blocked request spike"
          description: "{{ $value }} requests blocked in last 5 minutes"
          runbook: "https://wiki.sanaa.co/runbooks/waf"

      - alert: GdprExportBacklog
        expr: |
          gdpr_export_jobs_pending > 25
        for: 15m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "GDPR export backlog exceeded 25 jobs"
          description: "Pending exports: {{ $value }}"

      # Disaster recovery + backups
      - alert: BackupReplicationLagHigh
        expr: |
          backup_replication_lag_seconds > 600
        for: 10m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "Backup replication lag > 10 minutes"
          description: "Lag: {{ $value | humanizeDuration }}"
          runbook: "https://wiki.sanaa.co/runbooks/backup-replication"

      - alert: DrDrillFailure
        expr: |
          increase(dr_drill_failures_total[1d]) > 0
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: "Disaster recovery drill failure detected"
          description: "{{ $value }} failed DR drill(s) in last 24h"
          runbook: "https://wiki.sanaa.co/runbooks/dr-drill"
